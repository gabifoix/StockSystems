---
title: "Portfolio Assessment: Performance and selling strategies"
output:
  html_document:
    df_print: paged
---

A timely retreat is a victory.


Set of libraries to use
```{r message = FALSE, warning = FALSE}
library(YHFinR)
library(magrittr)
library(lubridate)
library(dplyr)
library(ggplot2)

source('R/Plots.R')
source('R/StockResearchCore.R')

```

Defining our portfolio
```{r}
date <- gsub("-", "", today())
Portfolio.df <- data.frame(Ticker = c("UNA.AS", "TGYM.MI", "VOW3.DE","PUM.DE",  "MC.PA", "CS.PA", "REE.MC"),
                        nShares = c(100, 650, 50, 80, 14, 300, 425),
                        AP = c(46, 7, 93, 55.40, 350, 16.10, 17.20),
                        stringsAsFactors = FALSE)
```

Download daily historical data from today back to 5 years. 
We take price adjusted by splits.

```{r message = FALSE, warning = FALSE}
HistPrices.yahoo.list <- YHFinR::getYFHistPrices(Portfolio.df$Ticker, "5y", "1wk")

```

Value of the current portfolio is `r sum(Portfolio.df$CP)`, allocated as follows.

```{r echo=FALSE}

Portfolio.df <- Portfolio.df %>% 
  mutate(CP = sapply(HistPrices.yahoo.list, function(x) tail(x$adjclose, 1)),
         CV = nShares * CP,
         weight = CV / sum(CV)) %>% 
  arrange(desc(weight))

Portfolio.df[, c("Ticker", "CV", "weight")]


```


** Factor 1: Quality **
1. Healthy debts: A company shoud generate cash in order to repay its debt. The **Free Cash Flow to Debt** ratio is a good indicator of how quick a company pays back its debt. The lower this ratio the better.

FCF2D = $\frac{Debt}{Free Cash Flow}$

```{r}
Financials.list <- YHFinR::getYFFinancialsBasics(Portfolio.df$Ticker)
FCF.Debt.ROA.df <- rbind(
  sapply(Financials.list, function(x) x$freeCashflow$raw) , 
  sapply(Financials.list, function(x) x$totalDebt$raw),
  sapply(Financials.list, function(x) x$returnOnAssets$raw)
  ) %>% 
  t() %>% 
  set_colnames(c("FCF", "Debt", "ROA")) %>% 
  as.data.frame() %>% 
  mutate(Ticker = rownames(.))

FCF.Debt.ROA.PF.df <- addPFavgFactor(FCF.Debt.ROA.df, Portfolio.df) %>% 
  mutate(FCF2D = Debt / FCF)

FCF2D.df <- FCF.Debt.ROA.PF.df %>% 
  .[ , c("Ticker", "FCF2D")] %>% 
  dplyr::arrange(desc(FCF2D)) 

barchartPFplot(FCF2D.df, "FCF2D")


```
2. Profitability: ROA



3. High Margin: We look for companies that generate free cash flow compare to its price. The **Free Cash Flow to Entreprise Value** ratio tells us how many years of cash flow would be needed to the return the 100% of the investment. Again, the lower, the better. Values bellow 1 would mean "free lunch".

FCF2EV = $\frac{EV}{Free Cash Flow}$

```{r}
EV <- sapply(YHFinR::getYFKeyStatistics(Portfolio.df$Ticker), function(x) x$enterpriseValue$raw)
FCF2EV <- EV / FCF


Portfolio.df %>% 
  left_join(EV)
```

 getYFKeyStatistics(Portfolio.df$)





