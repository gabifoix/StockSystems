---
title: "Portfolio Assessment: Performance and selling strategies"
output:
  html_document:
    df_print: paged
---

A timely retreat is a victory.


Set of libraries to use
```{r message = FALSE, warning = FALSE}
library(YHFinR)
library(magrittr)
library(lubridate)
library(dplyr)
library(ggplot2)
library(xts)
library(quantmod)


source('R/Plots.R')
source('R/StockResearchCore.R')
source('R/YahooFinanceUtils.R')

```

Defining our portfolio
```{r}
date <- gsub("-", "", today())
Portfolio.df <- data.frame(Ticker = c("UNA.AS", "TGYM.MI", "VOW3.DE","PUM.DE",  "MC.PA", "CS.PA", "REE.MC"),
                        nShares = c(100, 650, 50, 80, 14, 300, 425),
                        AP = c(46, 7, 93, 55.40, 350, 16.10, 17.20),
                        stringsAsFactors = FALSE)
```

Download daily historical data from today back to 5 years. 
We take price adjusted by splits.

```{r message = FALSE, warning = FALSE}
HistPrices.yahoo.list <- YHFinR::getYFHistPrices(Portfolio.df$Ticker, "5y", "1d")

```

Value of the current portfolio is `r sum(Portfolio.df$CP)`, allocated as follows.

```{r echo=FALSE}

Portfolio.df <- Portfolio.df %>% 
  mutate(CP = sapply(HistPrices.yahoo.list, function(x) tail(x$adjclose, 1)),
         CV = nShares * CP,
         weight = CV / sum(CV)) %>% 
  arrange(desc(weight))

Portfolio.df[, c("Ticker", "CV", "weight")]


```


** Factor 1: Quality **
1. Healthy debts: A company shoud generate cash in order to repay its debt. The **Free Cash Flow to Debt** ratio is a good indicator of how quick a company pays back its debt. The lower this ratio the better.

FCF2D = $\frac{Debt}{Free Cash Flow}$

```{r}
Financials.list <- YHFinR::getYFFinancialsBasics(Portfolio.df$Ticker)
FCF.Debt.ROA.df <- rbind(
  sapply(Financials.list, function(x) .cleaNA_Neg(x$freeCashflow$raw)) , 
  sapply(Financials.list, function(x) .cleaNA_Neg(x$totalDebt$raw)),
  sapply(Financials.list, function(x) .cleaNA_Neg(x$returnOnAssets$raw))
  ) %>% 
  t() %>% 
  set_colnames(c("FCF", "Debt", "ROA")) %>% 
  as.data.frame() %>% 
  mutate(Ticker = rownames(.))

FCF.Debt.ROA.PF.df <- addPFavgFactor(FCF.Debt.ROA.df, Portfolio.df) %>% 
  mutate(FCF2D = .cleaNA_Neg(Debt / FCF))

FCF2D.df <- FCF.Debt.ROA.PF.df %>% 
  .[ , c("Ticker", "FCF2D")] %>% 
  mutate(FCF2D = round(FCF2D, 2)) %>% 
  dplyr::arrange(desc(FCF2D)) 

barchartPFplot(FCF2D.df, "FCF2D")


```


2. Profitability: ROA
```{r}
ROA.df <- FCF.Debt.ROA.PF.df %>% 
  .[ , c("Ticker", "ROA")] %>% 
  mutate(ROA = round(ROA * 100, 2)) %>% 
  dplyr::arrange(desc(ROA)) 

barchartPFplot(ROA.df, "ROA")

```

3. High Margin: We look for companies that generate free cash flow compare to its price. The **Free Cash Flow to Entreprise Value** ratio tells us how many years of cash flow would be needed to the return the 100% of the investment. Again, the lower, the better. Values bellow 1 would mean "free lunch".

FCF2EV = $\frac{EV}{Free Cash Flow}$

```{r}
EV <- sapply(YHFinR::getYFKeyStatistics(Portfolio.df$Ticker), function(x) x$enterpriseValue$raw) 
EV.df <- EV %>% 
  as.data.frame() %>% 
  set_colnames(c("EV")) %>% 
  mutate(Ticker = rownames(.)) %>% 
  addPFavgFactor(Portfolio.df)

FCF.Debt.EV.ROA.PF.df <- FCF.Debt.ROA.PF.df %>% 
  left_join(EV.df, by = "Ticker") %>% 
  mutate(FCF2EV = .cleaNA_Neg(EV / FCF))

FCF2EV.df <- FCF.Debt.EV.ROA.PF.df %>% 
  .[ , c("Ticker", "FCF2EV")] %>% 
  mutate(FCF2EV = round(FCF2EV, 2)) %>% 
  dplyr::arrange(desc(FCF2EV)) 

barchartPFplot(FCF2EV.df, "FCF2EV")

```

** Factor 2: Momentum **

Don't hold onto a stock simply because it is high quality. So called quality stocks have cycles too. Stan Weinstein (page 177)

Generic Intermediate-Term Momentum
Based on Gray-Vogel (page 80)


```{r}
HistPrices.yahoo.list[["STOXX50E"]] <- YHFinR::getYFHistPrices("^STOXX50E", "5y", "1d")$`^STOXX50E`
HistPrices.yahoo.xts.list <- lapply(HistPrices.yahoo.list, convertHistPr2xts)

Momentum.df <- sapply(HistPrices.yahoo.xts.list, calcGenericMomentum, term = 36, noise = 1) %>% 
  as.data.frame() %>% 
  set_colnames("Momentum") %>% 
  mutate(Ticker = rownames(.),
         Momentum = round(Momentum, 2)) %>% 
  dplyr::arrange(desc(Momentum))


barchartPFplot(Momentum.df, VarName = "Momentum", PFTicker = "STOXX50E")


```

** Factor 3: Timing Signal **

Sell Signal - Pr < 1% SMA 30 weeks and slope negative
Hold Signal - No Sell


```{r}
# From Daily to Weekly
HistPrices.wk.list <- sapply(HistPrices.yahoo.xts.list, daily2weekly)
# Add SMA30 & SMA30 Slope
HistPrices.wk.ma.list <- sapply(HistPrices.wk.list, addMA)
HistPrices.wk.ma.list <- sapply(HistPrices.wk.ma.list, addMASlope)

sapply(HistPrices.wk.ma.list, function(obj, threshold = 0.01) {
  x <- tail(obj, 1)
  ifelse(x$adjclose < ((1 -threshold) * x$MA) & x$MA.Slope < 0, "SELL", "HOLD")
})

```



