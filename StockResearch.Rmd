---
title: "StockResearch"
author: "Gabriel Foix"
output:
  html_document:
    df_print: paged
date: "`r Sys.Date()`"
params:
  Ticker: Ticker
  Index: Index

---

Buy Quality at the a good momentum. Get rid of the fishy stocks on time. That's all.

```{r packages, echo=FALSE, message = FALSE, warning = FALSE}
# Set of libraries to use
library(YHFinR)
library(magrittr)
library(lubridate)
library(dplyr)
library(ggplot2)
library(xts)
library(quantmod)


source('R/Plots.R')
source('R/StockResearchCore.R')
source('R/YahooFinanceUtils.R')

```

### Define candidates
```{r candidates, echo=FALSE, message = FALSE, warning = FALSE}
date <- gsub("-", "", today())
Candidates.df <- data.frame(Ticker = params$Ticker,
                        stringsAsFactors = FALSE)

```


```{r HisPrices, echo=FALSE, message = FALSE, warning = FALSE}
# Download daily historical data from today back to 5 years. 
# We tUBake price adjusted by splits.
HistPrices.yahoo.list <- YHFinR::getYFHistPrices(Candidates.df$Ticker, "5y", "1d")
# Filter out NULL & hist < 1 year
HistPrices.yahoo.list <- HistPrices.yahoo.list[!sapply(HistPrices.yahoo.list, is.null)]
HistPrices.yahoo.list <- HistPrices.yahoo.list[sapply(HistPrices.yahoo.list, nrow) > 252]

# Save temp in case
remove("HistPrices.yahoo.list.tmp.rds")
saveRDS(HistPrices.yahoo.list, "HistPrices.yahoo.list.tmp.rds")

# After that, reduce Candidates
Candidates.df <- Candidates.df[Candidates.df$Ticker %in% names(HistPrices.yahoo.list),, drop = FALSE]

```

### Factor 1: Quality

1. Healthy debts: A company shoud generate cash in order to repay its debt. The **Free Cash Flow to Debt** ratio is a good indicator of how quick a company pays back its debt. The lower this ratio the better.

FCF2D = $\frac{Debt}{Free Cash Flow}$

```{r FCF2D, echo=FALSE, message = FALSE, warning = FALSE}
Financials.list <- YHFinR::getYFFinancialsBasics(Candidates.df$Ticker)

# Possibility of Shares Outstanding to avoid EV

FCF.Debt.ROA.df <- rbind(
  sapply(Financials.list, function(x) .cleaNA_Neg(x$freeCashflow$raw)) , 
  sapply(Financials.list, function(x) .cleaNA_Neg(x$totalDebt$raw)),
  sapply(Financials.list, function(x) .cleaNA_Neg(x$returnOnAssets$raw))
  ) %>% 
  t() %>% 
  set_colnames(c("FCF", "Debt", "ROA")) %>% 
  as.data.frame() %>% 
  mutate(Ticker = rownames(.),
         FCF2D = .cleaNA_Neg(Debt / FCF))


FCF2D.df <- FCF.Debt.ROA.df %>% 
  .[ , c("Ticker", "FCF2D")] 

barchartPFplot(FCF2D.df, "FCF2D", theHighertheBetter = FALSE, PFequallyweigthed = TRUE)


```


2. Profitability: ROA 

```{r ROA, echo=FALSE, message = FALSE, warning = FALSE}
ROA.df <- FCF.Debt.ROA.df %>% 
  .[ , c("Ticker", "ROA")] 

barchartPFplot(ROA.df, "ROA", PFequallyweigthed = TRUE, labelPer = TRUE)

```

3. High Margin: We look for companies that generate free cash flow compare to its price. The **Free Cash Flow to Entreprise Value** ratio tells us how many years of cash flow would be needed to the return the 100% of the investment. Again, the lower, the better. Values bellow 1 would mean "free lunch".

FCF2EV = $\frac{EV}{Free Cash Flow}$

```{r FCF2EV, echo=FALSE, message = FALSE, warning = FALSE}
EV <- sapply(YHFinR::getYFKeyStatistics(Candidates.df$Ticker), function(x) x$enterpriseValue$raw)

EV.df <- unlist(EV[sapply(EV, is.numeric)]) %>% 
  as.data.frame() %>% 
  set_colnames(c("EV")) %>% 
  mutate(Ticker = rownames(.)) 


FCF.Debt.EV.ROA.df <- FCF.Debt.ROA.df %>% 
  left_join(EV.df, by = "Ticker") %>% 
  mutate(FCF2EV = .cleaNA_Neg(EV / FCF))

FCF2EV.df <- FCF.Debt.EV.ROA.df %>% 
  .[ , c("Ticker", "FCF2EV")] 

barchartPFplot(FCF2EV.df, "FCF2EV", theHighertheBetter = FALSE, PFequallyweigthed = TRUE)

```

### Factor 2: Momentum 

Don't hold onto a stock simply because it is high quality. So called quality stocks have cycles too. Stan Weinstein (page 177)

Generic Intermediate-Term Momentum
Based on Gray-Vogel (page 80)


```{r Momentum, echo=FALSE, message = FALSE, warning = FALSE}
HistPrices.yahoo.list[["Index"]] <- YHFinR::getYFHistPrices(params$Index, "5y", "1d")$Index
HistPrices.yahoo.xts.list <- lapply(HistPrices.yahoo.list, convertHistPr2xts)

Momentum.df <- sapply(HistPrices.yahoo.xts.list, calcGenericMomentum, term = 36, noise = 1) %>% 
  as.data.frame() %>% 
  set_colnames("Momentum") %>% 
  mutate(Ticker = rownames(.))

barchartPFplot(Momentum.df, VarName = "Momentum", PFTicker = "Index")


```

###  Factor 3: Timing Signal

Sell Signal - Pr < 1% SMA 30 weeks and slope negative (< -0.2)
Buy Signal -  109% * SMA30 < Pr > SMA 30 and slope positive (> 0.2)
Hold Signal - Neither Buy nor Sell


```{r Signal, echo=FALSE, message = FALSE, warning = FALSE}
# From Daily to Weekly
HistPrices.wk.list <- lapply(HistPrices.yahoo.xts.list, daily2weekly)
# Add SMA30 & SMA30 Slope
HistPrices.wk.ma.list <- lapply(HistPrices.wk.list, addMA)
HistPrices.wk.ma.list <- lapply(HistPrices.wk.ma.list, addMASlope)

Signal.df <- sapply(HistPrices.wk.ma.list, function(obj, thresholdMA_SELL = 0.01, thresholdMA_BUY = 0.09,  thresholdSlope_SELL = -0.2, thresholdSlope_BUY = 0.2) {
  x <- tail(obj, 1)
  ifelse(x$adjclose < ((1 -thresholdMA_SELL) * x$MA) & x$MA.Slope < thresholdSlope_SELL, "SELL", 
         ifelse(x$adjclose < ((1 + thresholdMA_BUY) * x$MA) & x$adjclose > x$MA & x$MA.Slope > thresholdSlope_BUY, "BUY", "HOLD"))
}) %>% 
  as.data.frame %>% 
  set_colnames("Signal") %>% 
  mutate(Ticker = rownames(.))

```


###  Summary 
```{r Summary, echo=FALSE, message = FALSE, warning = FALSE}
# Quality
QualityRank <- FCF2D.df %>% 
  left_join(ROA.df, by = "Ticker") %>% 
  left_join(FCF2EV.df, by = "Ticker") %>%
  subset(Ticker != "PF") %>% 
  mutate(FCF2D = 1/ FCF2D,
         FCF2EV = 1 / FCF2EV) %>% 
  rankVariables(Rank.Name = "Quality", VarCols = c("FCF2D", "ROA","FCF2EV"))

# Quality
MomentumRank <- Momentum.df %>% 
  rankVariables(Rank.Name = "Momentum", VarCols = c("Momentum"))

# All together
FinalRank <- QualityRank %>% 
  left_join(MomentumRank, by = "Ticker") %>% 
  rankVariables(VarCols = c("Quality", "Momentum"), KeepVarCols = TRUE)

Summary <- Candidates.df %>% 
  left_join(Signal.df, by = "Ticker") %>% 
  left_join(FinalRank, by = "Ticker") 

knitr::kable(
  Summary[ , c("Ticker", "Signal", "Quality", "Momentum", "Final_rank")] %>%
    arrange(desc(Final_rank)) 
  , caption = "Summary")

```


